<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Colorado Resource Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" type="text/css" crossorigin="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js" crossorigin=""></script>
    <!--Jquery used to make a web request to query the WMS. This will allow popups to show information about a feature on the map.-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css">
    <script type="text/javascript"></script>
    <style>
      #map {
        width: 90%;
        height: 90%;
      }
    </style>
  </head>
  <body onload="init()"></body>>
    <!--Html to create a title and a small about section for the map.-->
    <h1 id="title">Resources in Colorado</h1>
    <div id="mapid">
      </div>
    <div id="docs">
      <p>This page shows resources in Colorado. Click a point of interest to get more information.</p>
      </div>
    <div id="map"></div>  
    <script>
      //Create map, set the view center lat / long / zoom, and add open street map baselayer.
      var map;
      function init() {
        map = new L.map('map');
        map.setView([39.7392, -104.991531], 10);

        var tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        tiles.addTo(map);

        // Create variables that represent the wms layers hosted on GeoServer.
        var co_coal = L.tileLayer.wms("http://44.194.230.10:8080/geoserver/Colorado_Resources/wms", {
          layers: 'Colorado_Resources:co_coal',
          format: 'image/png',
          transparent: true,
          version: '1.1.0',
        }).addTo(map);;

        //var co_hardrock = L.tileLayer.wms("http://44.194.230.10:8080/geoserver/Colorado_Resources/wms", {
          //layers: 'Colorado_Resources:co_hardrock',
          //format: 'image/png',
          //transparent: true,
          //version: '1.1.0',
        //});

        //var co_oil_gas = L.tileLayer.wms("http://44.194.230.10:8080/geoserver/Colorado_Resources/wms", {
          //layers: 'Colorado_Resources:co_oil_gas_revised',
          //format: 'image/png',
          //transparent: true,
          //version: '1.1.0',
          //opacity: 0.4,
        //});

        //var co_outline = L.tileLayer.wms("http://44.194.230.10:8080/geoserver/Colorado_Resources/wms", {
          //layers: 'Colorado_Resources:co_outline',
          //format: 'image/png',
          //transparent: true,
          //version: '1.1.0',
        //}).addTo(map);

        // Create a layer group for variables found above. This will help to create the layer control widget. 
        //var layers = {
          //"Coal Permits": co_coal,
          //"Hardrock Permits": co_hardrock,
          //"Oil and Gas Production": co_oil_gas
        //};

        //Create layer control to switch between layers on the map.
        //L.control.layers(layers).addTo(map);

        //Define event handler function for click events.
        function Identify(e)
        // set parameters needed for GetFeatureInfo WMS request
        {
          var sw = map.options.crs.project(map.getBounds().getSouthWest());
          var ne = map.options.crs.project(map.getBounds().getNorthEast());
          var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
          var WIDTH = map.getSize().x;
          var HEIGHT = map.getSize().y;
          var X = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).x);
          var Y = Math.trunc(map.layerPointToContainerPoint(e.layerPoint).y);
        // compose the URL for the request
          var URL = 'http://44.194.230.10:8080/geoserver/Colorado_Resources/wms?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetFeatureInfo&LAYERS=Colorado_Resources:co_coal&QUERY_LAYERS=Colorado_Resources:co_coal&BBOX='+BBOX+'&FEATURE_COUNT=1&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I='+X+'&J='+Y;
        }
        map.addEventListener('click', Identify);

        //send GetFeatureInfo as asynchronous HTTP request using jQuery $.ajax
        $.ajax({
          url: URL,
          dataType: "json",
          type: "GET",
          success: function(data)
          {
            if(data.features.length !== 0) {  // at least one feature returned in response
              var returnedFeature = data.features[0]; // first feature from response
          
             // Set up popup for clicked feature and open it
              var popup = new L.Popup({
                  maxWidth: 300
              });

              popup.setContent("<b>" + returnedFeature.properties.sitename + "</b><br />" + returnedFeature.properties.permittee);
              popup.setLatLng(e.latlng);
              map.openPopup(popup);
          }
        }
      });
    } 
    </script>
  </body>
</html>
